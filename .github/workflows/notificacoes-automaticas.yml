name: üöÄ Sistema de Notifica√ß√µes Autom√°ticas

on:
  schedule:
    # Executa a cada 30 minutos
    - cron: '*/30 * * * *'
  
  # Permite execu√ß√£o manual
  workflow_dispatch:
    inputs:
      debug:
        description: 'Modo debug'
        required: false
        default: 'false'

jobs:
  processar-notificacoes:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout do c√≥digo
      uses: actions/checkout@v4
    
    - name: üöÄ Processar Notifica√ß√µes Autom√°ticas
      run: |
        echo "üöÄ Iniciando processamento de notifica√ß√µes autom√°ticas..."
        echo "‚è∞ Timestamp: $(date)"
        
        # Chamar a Edge Function do Supabase
        RESPONSE=$(curl -s -X POST \
          'https://ruagsbbczuwgfflgcaol.supabase.co/functions/v1/dynamic-responder' \
          -H 'Content-Type: application/json' \
          -H 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' \
          -d '{
            "trigger": "github_actions",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'",
            "debug": "${{ github.event.inputs.debug || 'false' }}"
          }')
        
        echo "üìß Resposta da Edge Function:"
        echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
        
        # Verificar se houve sucesso
        SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
        if [ "$SUCCESS" = "true" ]; then
          echo "‚úÖ Notifica√ß√µes processadas com sucesso!"
          
          # Extrair estat√≠sticas
          TOTAL_ENVIADOS=$(echo "$RESPONSE" | jq -r '.resumo.total_enviados // 0')
          TOTAL_ERROS=$(echo "$RESPONSE" | jq -r '.resumo.total_erros // 0')
          NOVOS_PRODUTOS=$(echo "$RESPONSE" | jq -r '.resumo.novos_produtos.enviados // 0')
          LEMBRETES=$(echo "$RESPONSE" | jq -r '.resumo.lembretes.enviados // 0')
          
          echo "üìä Estat√≠sticas:"
          echo "   üìß Total enviados: $TOTAL_ENVIADOS"
          echo "   ‚ùå Total erros: $TOTAL_ERROS"
          echo "   üéâ Novos produtos: $NOVOS_PRODUTOS"
          echo "   üìã Lembretes: $LEMBRETES"
          
          # Salvar estat√≠sticas em arquivo
          echo "$(date): Enviados=$TOTAL_ENVIADOS, Erros=$TOTAL_ERROS, Produtos=$NOVOS_PRODUTOS, Lembretes=$LEMBRETES" >> notificacoes-log.txt
          
        else
          echo "‚ùå Erro no processamento de notifica√ß√µes:"
          echo "$RESPONSE"
          exit 1
        fi
    
    - name: üìä Registrar Execu√ß√£o
      if: always()
      run: |
        echo "üìã Registrando execu√ß√£o..."
        
        # Registrar execu√ß√£o via Edge Function (mais simples e seguro)
        curl -s -X POST \
          'https://ruagsbbczuwgfflgcaol.supabase.co/functions/v1/dynamic-responder' \
          -H 'Content-Type: application/json' \
          -H 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' \
          -d '{
            "trigger": "log_execution",
            "execution_type": "github_actions",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"
          }'
        
        echo "‚úÖ Execu√ß√£o registrada no banco de dados"
    
    - name: üîç Debug (se habilitado)
      if: github.event.inputs.debug == 'true'
      run: |
        echo "üîç Informa√ß√µes de debug:"
        echo "Repository: ${{ github.repository }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Event: ${{ github.event_name }}"
        echo "Timestamp: $(date)"
        
        # Verificar se h√° usu√°rios pendentes via Edge Function
        echo "üîç Verificando usu√°rios pendentes..."
        curl -s -X POST \
          'https://ruagsbbczuwgfflgcaol.supabase.co/functions/v1/dynamic-responder' \
          -H 'Content-Type: application/json' \
          -H 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' \
          -d '{"trigger": "debug_check"}' | jq '.'